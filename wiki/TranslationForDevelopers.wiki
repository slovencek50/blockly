#summary Information about translation for Blockly developers

This document provides what developers should know about Blockly translations.  Translators should read [https://code.google.com/p/blockly/wiki/Translation this document] instead.

<wiki:toc max_depth="4" />

= Introduction =

Internationalization (i18n) is one of Blockly's top priorities.  See, for example, [https://neil.fraser.name/news/2013/03/16/ CS in VN].  Blockly supports right-to-left and left-to-right scripts, and the [http://blockly-demo.appspot.com/static/apps/puzzle/index.html Puzzle application] has been translated into over 50 languages.  We look forward to getting all of Blockly translated into that many languages.

= !TranslateWiki =
We use [http://www.translatewiki.net TranslateWiki] as our translation console and translator community.  We provide them with the following files:
  * *qqq.json*, mapping message names to _message documentation_ (information for translators).
  * *en.json*, mapping message names to the English-language text.  Note that we use Canadian English.
  * *_LANG_.json*, mapping message names to the appropriate language text.  Messages that have not been translated to the given language will not be present in this file.
_LANG_ is (loosely) an [http://en.wikipedia.org/wiki/IETF_language_tag IETF language tag], such as "de" for German or "pt-br" for Brazilian Portuguese.  See this [https://translatewiki.net/wiki/Special:SupportedLanguages incomplete list of languages supported by translatewiki].

Here are links to files for translating the tutorials and applications:
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/qqq.json apps/qqq.json]
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/en.json apps/en.json]
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/de.json apps/de.json] (as one example of a non-English language file).

= Applications and Tutorials =

The Blockly applications and tutorials (henceforth referred to as "apps") are built with "Soy", also known as [https://developers.google.com/closure/templates/ Google Closure templates], which has [https://developers.google.com/closure/templates/docs/translation translation tools].  Specifically, all messages appear in files whose name ends with the "soy" extension.   Messages used by multiple apps are defined in [https://code.google.com/p/blockly/source/browse/trunk/apps/common.soy apps/common.soy], and have the prefix "Apps."  Messages used by only a single app are defined in that app's template.soy file, such as [https://code.google.com/p/blockly/source/browse/trunk/apps/maze/template.soy apps/maze/template.soy] and prefixed with the name of the application, such as "Maze.".

== The msg tag ==
Here is an example of a message definition:

{{{
{msg meaning="Maze.moveForward" 
     desc="block text - Imperative or infinitive of a verb fo r a person moving 
           (walking) in the direction he/she is facing."}
  move forward
{/msg}
}}}

Notes:
  * The key is defined through the "meaning" attribute: "Maze.moveForward".
  * The message documentation for the translator is defined through the "desc" attribute.  This appears as the value in the qqq.json file.
  * The English language text appears between the "msg" start and end tags.  This appears as the value in the en.json file.
 
A left brace or right brace can be included in an attribute value by using double braces to introduce and close the "msg" tags and writing "{lb}" [left brace] for "{" or "{rb}" for "}", as in this definition:

{{{
{{msg meaning="Puzzle.country1Language" 
      desc="The English language.{lb}{lb}Identical|English{rb}{rb}"}}
  English
{{/msg}}
}}}
(The !TranslateWiki "Identical" tag is shrouded in mystery.  It was added to a Blockly file by a !TranslateWiki wizard, and I was told not to worry about why.)

== Placement of the msg tag ==

=== Messages used only once within a template ===

If a message is used only once and the use is within the template, it can be defined where it is used:

{{{
<button class="notext" 
        title="{msg meaning="Apps.codeTooltip" 
                    desc="tooltip (pop-up help) for button; pressing the button causes a program in the
                          JavaScript computer language to be displayed, based on the program created by the user."}
                 See generated JavaScript code.
            {/msg}" 
        onclick="BlocklyApps.showCode(this);">
  <img src="../../media/1x1.gif" class="code icon21">
</button>
}}}


=== Messages referenced from !JavaScript files===
If a message is used by a !JavaScript file, such as maze.js or blocks.js, it must be declared within a span:

{{{
<span id="Maze_moveForward">
  {msg meaning="Maze.moveForward" 
       desc="block text - Imperative or infinitive of a verb for a person moving 
             (walking) in the direction he/she is facing."}
    move forward
  {/msg}
</span>
}}}
By convention, the id of the span is the same as the "meaning" key but replaces periods with underscores.  The message is referenced from code through the method {{{BlocklyApps.getMsg()}}}, as in the example below from [https://code.google.com/p/blockly/source/browse/trunk/apps/maze/blocks.js apps/maze/blocks.js]:

{{{
Blockly.Language.maze_moveForward = {
  // Block for moving forward.  [A portion of the following code is omitted.]
  init: function() {
    this.setColour(290);
    this.appendDummyInput()
        .appendTitle(BlocklyApps.getMsg('Maze_moveForward'));
  }
};
}}}

=== Messages used multiple times===
If a message is used multiple times within one or multiple template files, all "msg" tags should have the same "meaning" attribute and enclosed text, but only one should have the real description as the "desc" attribute.  The others should have "IBID" (case-insensitive).

If a message is used in more than one app, it should be defined within a span in [https://code.google.com/p/blockly/source/browse/trunk/apps/common.soy apps/common.soy], and its meaning should be prefixed with "Apps.".  For example, common.soy includes:

{{{
<span id="blocklyMessage">
  {msg meaning="Apps.blocklyMessage" 
         desc="The project name.  If readers of your language would know approximately how to pronounce 'Blockly', 
               leave unchanged.  Otherwise, include a transliteration in parentheses, such as the Russian:
               'Blockly (\u0411\u043bo\u043a\u043b\u0438)'."}
     Blockly
  {/msg}
</span>
}}}

Here is a sample use from [https://code.google.com/p/blockly/source/browse/trunk/apps/turtle/template.soy apps/turtle/template.soy]:
{{{
<a href="../index.html">{msg meaning="Apps.blocklyMessage" desc="IBID"}Blockly{/msg}</a>
}}}

==Build process==

=== Building a single app in English ===

Every app's template.soy file contains a comment near the top describing how to rebuild its English-language message file (apps/`*`/generated/en.js).  For example, this command appears at the top of [https://code.google.com/p/blockly/source/browse/trunk/apps/turtle/template.soy apps/turtle/template.soy]:

{{{
java -jar ../_soy/SoyToJsSrcCompiler.jar --outputPathFormat generated/en.js --srcs ../common.soy,template.soy
}}}

When run in the apps/turtle directory, this rebuilds [https://code.google.com/p/blockly/source/browse/trunk/apps/turtle/generated/en.js apps/turtle/generated/en.js].

Emacs users might want to add the following to their .emacs file to automatically regenerate the appropriate en.js file whenever a template.soy file is saved:
{{{
(add-hook 'after-save-hook
  (lambda ()
    (if (string-match "^template.soy\\(<.*>\\)?$" (buffer-name))
	(shell-command "java -jar ../_soy/SoyToJsSrcCompiler.jar --outputPathFormat generated/en.js --srcs ../common.soy,template.soy"))))
}}}
Of course, if you have a different path to `_soy` or wish to generate "en_us.js" instead of "en.js", you will need to change the command.


=== Doing a full build ===

Before checking in code, developers should do a full i18n build by following the instructions in comments at the top of [https://code.google.com/p/blockly/source/browse/trunk/apps/common.soy apps/common.soy].  The below diagram shows the build process.   It is followed by a description of each step.

[https://blockly.googlecode.com/svn/wiki/i18n_block_diagram.png]

==== !SoyMsgExtractor.jar ====

<font color="orange">!SoyMsgExtractor.jar</font> extracts the messages from the template files into `extracted_msgs.xlf`.  For example, this message:

{{{
{msg meaning="Maze.moveForward" 
     desc="block text - Imperative or infinitive of a verb for a person moving 
           (walking) in the direction he/she is facing."}
  move forward
{/msg}
}}}

becomes:

{{{
<trans-unit id="4138774728570944645" datatype="html">
  <source>move forward</source>
  <note priority="1" from="description">block text - Imperative or infinitive of a verb for a person moving
                           (walking) in the direction he/she is facing.</note>
  <note priority="1" from="meaning">Maze.moveForward</note>
</trans-unit>
}}}

The `id` is some sort of hash value that changes whenever the message description changes.

==== xliff_to_json.py ====

The script <font color="magenta">[https://code.google.com/p/blockly/source/browse/trunk/i18n/xliff_to_json.py xliff_to_json.py]</font> takes `extracted_msgs.xlf` as input and generates three JSON files that use message "meanings" (such as `Maze.moveForward') as keys:
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/qqq.json qqq.json], where the values are the message documentation (translator instructions).
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/en.json en.json], where the values are the English-language messages (e.g., "move forward").
  * [https://code.google.com/p/blockly/source/browse/trunk/apps/keys.json keys.json], where the values are `id`s from `extracted_msgs.xlf`, such as "4138774728570944645".

Note that these do not change the other languages' json files, which were generated by <font color="blue">translatewiki</font>.  These files are automatically picked up by Siebrand Mazeland at translatewiki, who periodically checks in updated qqq.json and other languages' JSON files as blockly@translatewiki.net.

==== json_to_js.py ====

Finally, the script <font color="red">json_to_js.py</font> uses the JSON files and template files to generate !JavaScript files for each app-language combination, such as [https://code.google.com/p/blockly/source/browse/trunk/apps/maze/generated/es.js apps/maze/generated/es.js], the Spanish translation of the maze application.